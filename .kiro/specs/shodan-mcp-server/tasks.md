# 実装計画: Shodan MCP Server

## 概要

既存のShodan MCP Serverコードベースに対して、包括的なテストスイートを追加し、コードの正確性を検証します。実装は完了しているため、テストの追加とドキュメントの改善に焦点を当てます。

## タスク

- [ ] 1. テスト環境のセットアップ
  - pytest、pytest-asyncio、pytest-mock、hypothesisをpyproject.tomlに追加
  - テストディレクトリ構造を作成（tests/、tests/unit/、tests/property/）
  - 共通フィクスチャファイル（conftest.py）を作成
  - _要件: 10.1, 11.1_

- [ ] 2. APIキー管理のテスト実装
  - [ ] 2.1 get_api_key()関数のユニットテストを作成
    - APIキー未設定時のValueErrorテスト
    - 環境変数のクリーンアップフィクスチャを実装
    - _要件: 1.5, 11.2_
  
  - [ ]* 2.2 APIキー優先順位のプロパティテストを作成
    - **プロパティ1: APIキー引数の優先順位**
    - **検証: 要件 1.1**
  
  - [ ]* 2.3 Streaming API環境変数フォールバックのプロパティテストを作成
    - **プロパティ2: Streaming API環境変数フォールバック**
    - **検証: 要件 1.2**
  
  - [ ]* 2.4 Trends API環境変数フォールバックのプロパティテストを作成
    - **プロパティ3: Trends API環境変数フォールバック**
    - **検証: 要件 1.3**
  
  - [ ]* 2.5 デフォルト環境変数フォールバックのプロパティテストを作成
    - **プロパティ4: デフォルト環境変数フォールバック**
    - **検証: 要件 1.4**

- [ ] 3. チェックポイント - テストが通ることを確認
  - すべてのテストが合格することを確認し、質問があればユーザーに尋ねる

- [ ] 4. REST APIツールのテスト実装
  - [ ] 4.1 httpx.AsyncClientモックフィクスチャを作成
    - モックレスポンスヘルパー関数を実装
    - 非同期コンテキストマネージャーのモックを設定
    - _要件: 2.1, 3.1_
  
  - [ ] 4.2 オプションパラメータのユニットテストを作成
    - history、minify、facets、pageパラメータのテスト
    - 各パラメータがリクエストに正しく含まれることを検証
    - _要件: 2.2, 2.3, 3.2, 3.3_
  
  - [ ]* 4.3 オプションパラメータのプロパティテストを作成
    - **プロパティ5: オプションパラメータのリクエスト含有**
    - **検証: 要件 2.2, 2.3, 3.2, 3.3**
  
  - [ ] 4.4 HTTPエラーハンドリングのユニットテストを作成
    - 401、403、404、429、500ステータスコードのテスト
    - HTTPStatusErrorが正しく発生することを検証
    - _要件: 2.4, 11.1, 11.3_
  
  - [ ]* 4.5 HTTPエラー伝播のプロパティテストを作成
    - **プロパティ6: HTTPエラーの伝播**
    - **検証: 要件 2.4, 11.1, 11.3**

- [ ] 5. SSEパーサーのテスト実装
  - [ ] 5.1 _parse_sse_events()関数のユニットテストを作成
    - 空のストリーム、単一イベント、複数イベントのテスト
    - 既知のSSE形式文字列を使用した検証
    - _要件: 8.5_
  
  - [ ]* 5.2 SSEイベント解析のプロパティテストを作成
    - **プロパティ7: SSEイベント解析の正確性**
    - **検証: 要件 8.5**
  
  - [ ] 5.3 limitパラメータのユニットテストを作成
    - limit=0、limit=1、limit=10のエッジケース
    - 十分なイベントがある場合とない場合のテスト
    - _要件: 8.4_
  
  - [ ]* 5.4 ストリーミングlimitパラメータのプロパティテストを作成
    - **プロパティ8: ストリーミングlimitパラメータの遵守**
    - **検証: 要件 8.4**

- [ ] 6. チェックポイント - テストが通ることを確認
  - すべてのテストが合格することを確認し、質問があればユーザーに尋ねる

- [ ] 7. Streaming APIツールのテスト実装
  - [ ] 7.1 ストリーミングモックフィクスチャを作成
    - 非同期イテレータをモックするヘルパー関数
    - SSE形式データを生成するユーティリティ
    - _要件: 8.1, 8.2, 8.3_
  
  - [ ]* 7.2 各ストリーミングツールのユニットテストを作成
    - firehose、ports、alertストリームのテスト
    - モックストリームからのイベント取得を検証
    - _要件: 8.1, 8.2, 8.3_

- [ ] 8. Trends APIツールのテスト実装
  - [ ] 8.1 デフォルトdaysパラメータのユニットテストを作成
    - daysパラメータなしで呼び出し
    - リクエストに"days": 30が含まれることを検証
    - _要件: 9.4_
  
  - [ ]* 8.2 Trends APIデフォルト値のプロパティテストを作成
    - **プロパティ9: Trends APIデフォルトdays値**
    - **検証: 要件 9.4**
  
  - [ ]* 8.3 各Trends APIツールのユニットテストを作成
    - top_ports、top_orgs、top_countriesのテスト
    - モックレスポンスを使用した検証
    - _要件: 9.1, 9.2, 9.3_

- [ ] 9. テストカバレッジの測定と改善
  - [ ] 9.1 pytest-covをpyproject.tomlに追加
    - カバレッジレポート設定を追加
    - _要件: すべて_
  
  - [ ] 9.2 カバレッジレポートを生成
    - 行カバレッジ90%以上を目標
    - 分岐カバレッジ85%以上を目標
    - _要件: すべて_
  
  - [ ] 9.3 カバレッジが不足している部分のテストを追加
    - カバレッジレポートを確認
    - 不足している分岐やエッジケースのテストを追加
    - _要件: すべて_

- [ ] 10. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが合格することを確認し、質問があればユーザーに尋ねる

## 注記

- `*`マークのタスクはオプションであり、より高速なMVPのためにスキップ可能
- 各タスクは特定の要件を参照してトレーサビリティを確保
- チェックポイントで段階的な検証を実施
- プロパティテストは普遍的な正確性プロパティを検証
- ユニットテストは特定の例とエッジケースを検証
- 既存の実装コード（server.py）は変更不要
