# データ入出力分析ドキュメント

## 目次

1. [概要](#概要)
2. [データフロー分析](#データフロー分析)
3. [入力データ検証](#入力データ検証)
4. [外部データソース分析](#外部データソース分析)
5. [セキュリティ分析](#セキュリティ分析)
6. [データ漏洩リスク評価](#データ漏洩リスク評価)
7. [推奨事項](#推奨事項)

---

## 概要

本ドキュメントは、Shodan MCP Serverにおけるデータの入出力を分析し、以下の観点から評価します：

- **入力データの出所**: MCPクライアントからの入力値のみが使用されているか
- **外部データの使用**: 環境変数、ファイルシステム、その他の外部ソースからのデータ
- **データの変換**: 入力データがどのように処理・変換されるか
- **出力データの内容**: APIレスポンスに含まれるデータの種類
- **セキュリティリスク**: データ漏洩、インジェクション攻撃などのリスク

---

## データフロー分析

### 全体的なデータフロー

```
┌─────────────────────────────────────────────────────────────┐
│ MCPクライアント (Claude Desktop, CLI, etc.)                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓ (1) ツール呼び出し + パラメータ
┌─────────────────────────────────────────────────────────────┐
│ Shodan MCP Server (server.py)                               │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ (2) 入力パラメータ受信                                │   │
│  │  - ip, query, hostnames, domain, port, etc.         │   │
│  │  - api_key (オプション)                              │   │
│  │  - history, minify, facets, page, limit, days, etc. │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ (3) 環境変数からAPIキー取得 (入力にない場合)         │   │
│  │  - SHODAN_API_KEY                                    │   │
│  │  - SHODAN_STREAM_API_KEY                             │   │
│  │  - SHODAN_TRENDS_API_KEY                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ (4) HTTPリクエストパラメータ構築                      │   │
│  │  - 入力パラメータをそのまま使用                       │   │
│  │  - APIキーを追加                                     │   │
│  │  - URL構築 (f-string)                                │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ↓ (5) HTTPS リクエスト
┌─────────────────────────────────────────────────────────────┐
│ Shodan API (api.shodan.io, stream.shodan.io, etc.)         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓ (6) JSON/SSE レスポンス
┌─────────────────────────────────────────────────────────────┐
│ Shodan MCP Server (server.py)                               │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ (7) レスポンス処理                                    │   │
│  │  - JSON解析 (resp.json())                            │   │
│  │  - SSE解析 (_parse_sse_events())                     │   │
│  │  - エラーチェック (raise_for_status())               │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ↓ (8) 結果返却
┌─────────────────────────────────────────────────────────────┐
│ MCPクライアント                                              │
└─────────────────────────────────────────────────────────────┘
```

### データソースの分類

#### 1. MCPクライアントからの入力（ユーザー制御）

すべてのツール関数は、MCPクライアントから以下のパラメータを受け取ります：

**必須パラメータ:**
- `ip` (str): IPアドレス
- `query` (str): 検索クエリ
- `hostnames` (str): ホスト名リスト
- `ips` (str): IPアドレスリスト
- `domain` (str): ドメイン名
- `host` (str): ホスト名
- `port` (int): ポート番号
- `dataset` (str): データセット名

**オプションパラメータ:**
- `api_key` (Optional[str]): APIキー
- `history` (Optional[bool]): 履歴フラグ
- `minify` (Optional[bool]): 最小化フラグ
- `facets` (Optional[str]): ファセット指定
- `page` (Optional[int]): ページ番号
- `limit` (Optional[int]): イベント数制限
- `days` (int): 集計期間
- `size` (Optional[int]): サイズ指定

#### 2. 環境変数からの入力（システム管理者制御）

APIキーのみが環境変数から取得されます：

```python
# get_api_key() 関数内
os.getenv("SHODAN_API_KEY")
os.getenv("SHODAN_STREAM_API_KEY")
os.getenv("SHODAN_TRENDS_API_KEY")
```

**重要な観察:**
- 環境変数から取得されるのは**APIキーのみ**
- その他のデータ（検索クエリ、IPアドレスなど）は環境変数から取得されない
- APIキーは認証情報であり、ユーザーデータではない

#### 3. ハードコードされた定数

以下の定数がコード内で定義されています：

```python
SHODAN_API_BASE = "https://api.shodan.io"
SHODAN_STREAM_BASE = "https://stream.shodan.io"
SHODAN_TRENDS_BASE = "https://trends.shodan.io"
```

**重要な観察:**
- これらは**エンドポイントURL**であり、ユーザーデータではない
- 変更不可能な固定値
- セキュリティリスクなし

#### 4. 外部APIからのレスポンス

Shodan APIからのレスポンスデータ：

```python
# REST API
return resp.json()  # Shodan APIからのJSONレスポンス

# Streaming API
return await _parse_sse_events(resp.aiter_bytes(), limit_val)  # SSEイベントリスト

# Tools API
return resp.text  # プレーンテキスト (myip)
```

**重要な観察:**
- レスポンスデータは**そのまま返却**される
- サーバー側での加工や追加データの混入なし
- Shodan APIからのデータのみ


---

## 入力データ検証

### 現在の実装状況

**検証が行われていない項目:**

すべてのツール関数において、入力パラメータの検証は**実装されていません**：

```python
# 例: shodan_host_info()
async def shodan_host_info(ip: str, api_key: Optional[str] = None, 
                          history: Optional[bool] = False, 
                          minify: Optional[bool] = False) -> dict:
    # 入力検証なし
    key = get_api_key(api_key, api_type="rest")
    params = {"key": key}
    if history:
        params["history"] = "true"
    if minify:
        params["minify"] = "true"
    url = f"{SHODAN_API_BASE}/shodan/host/{ip}"  # ipをそのまま使用
    # ...
```

### 入力データの使用方法

#### 1. URL構築での使用

入力パラメータは**f-string**を使用してURLに直接埋め込まれます：

```python
# IPアドレスをURLパスに埋め込み
url = f"{SHODAN_API_BASE}/shodan/host/{ip}"

# ポート番号をURLパスに埋め込み
url = f"{SHODAN_STREAM_BASE}/shodan/port/{port}?key={key}"

# データセット名をURLパスに埋め込み
url = f"{SHODAN_API_BASE}/shodan/data/{dataset}"

# ドメイン名をクエリパラメータに含める
params = {"key": key, "domain": domain}
```

**潜在的なリスク:**
- **URLインジェクション**: 特殊文字（`/`, `?`, `&`, `#`など）が含まれる場合、URLが破壊される可能性
- **パストラバーサル**: `../`などが含まれる場合、意図しないエンドポイントにアクセスされる可能性
- ただし、httpxライブラリが適切にエンコードするため、実際のリスクは低い

#### 2. クエリパラメータでの使用

入力パラメータは辞書に格納され、httpxに渡されます：

```python
params = {"key": key, "query": query, "page": page}
# httpxが自動的にURLエンコード
resp = await client.get(url, params=params)
```

**セキュリティ対策:**
- httpxライブラリが自動的にURLエンコードを実行
- SQLインジェクションのリスクなし（データベースに直接アクセスしないため）
- コマンドインジェクションのリスクなし（シェルコマンドを実行しないため）

#### 3. 型ヒントによる暗黙的な検証

Python型ヒントが使用されていますが、実行時の検証は行われません：

```python
async def shodan_host_search(query: str, api_key: Optional[str] = None, 
                             facets: Optional[str] = None, 
                             page: Optional[int] = 1, 
                             minify: Optional[bool] = False) -> dict:
```

**制限事項:**
- 型ヒントは**ドキュメント目的**のみ
- 実行時に型チェックは行われない
- 誤った型が渡されてもエラーにならない可能性

### 検証が必要な入力項目

#### 高リスク項目

1. **IPアドレス (`ip`)**
   - 現状: 検証なし
   - リスク: 不正な形式のIPアドレスがShodan APIに送信される
   - 推奨: IPv4/IPv6形式の検証

2. **ポート番号 (`port`)**
   - 現状: int型ヒントのみ
   - リスク: 範囲外の値（負の数、65535超）
   - 推奨: 1-65535の範囲チェック

3. **ドメイン名 (`domain`)**
   - 現状: 検証なし
   - リスク: 不正な形式のドメイン名
   - 推奨: ドメイン名形式の検証

4. **データセット名 (`dataset`)**
   - 現状: 検証なし
   - リスク: パストラバーサル攻撃（`../`など）
   - 推奨: 英数字とハイフンのみ許可

#### 中リスク項目

5. **検索クエリ (`query`)**
   - 現状: 検証なし
   - リスク: Shodan APIの構文エラー
   - 推奨: 長さ制限、特殊文字のチェック

6. **ページ番号 (`page`)**
   - 現状: int型ヒントのみ
   - リスク: 負の数、過大な値
   - 推奨: 正の整数チェック

7. **limit値 (`limit`)**
   - 現状: int型ヒントのみ
   - リスク: 負の数、過大な値（メモリ消費）
   - 推奨: 1-1000の範囲チェック

#### 低リスク項目

8. **ブール値 (`history`, `minify`)**
   - 現状: bool型ヒント
   - リスク: 低（True/Falseのみ）
   - 推奨: 現状維持

---

## 外部データソース分析

### 使用されている外部データソース

#### 1. 環境変数（os.getenv）

**使用箇所:**
```python
# get_api_key() 関数内（13-30行目）
os.getenv("SHODAN_API_KEY")
os.getenv("SHODAN_STREAM_API_KEY")
os.getenv("SHODAN_TRENDS_API_KEY")
```

**分析:**
- **目的**: APIキーの取得（認証情報）
- **データの性質**: 秘密情報（機密性高）
- **制御**: システム管理者が設定
- **リスク**: 環境変数が漏洩した場合、APIキーが露出
- **使用方法**: HTTPリクエストのクエリパラメータとして送信

**重要な観察:**
- APIキー以外の環境変数は**使用されていない**
- ユーザーデータ（検索クエリ、IPアドレスなど）は環境変数から取得されない
- 環境変数の使用は**認証目的のみ**

#### 2. Shodan API（外部HTTPエンドポイント）

**使用箇所:**
すべてのツール関数でhttpx.AsyncClientを使用してShodan APIにアクセス

**分析:**
- **目的**: Shodanのデータ取得
- **データの性質**: 公開情報（Shodanが収集したインターネットデータ）
- **制御**: Shodan社が管理
- **リスク**: Shodan APIが侵害された場合、不正なデータが返される可能性
- **使用方法**: レスポンスをそのままMCPクライアントに返却

**重要な観察:**
- Shodan APIからのレスポンスは**検証されていない**
- レスポンスデータは**そのまま返却**される
- サーバー側でのフィルタリングや加工なし

### 使用されていない外部データソース

以下のデータソースは**使用されていません**：

1. **ファイルシステム**: ファイルの読み書きなし
2. **データベース**: データベース接続なし
3. **他の環境変数**: APIキー以外の環境変数は使用されない
4. **システムコマンド**: シェルコマンドの実行なし
5. **ネットワークインターフェース**: ローカルIPアドレスの取得なし
6. **時刻情報**: タイムスタンプの追加なし
7. **ランダム値**: 乱数生成なし
8. **グローバル変数**: 状態を保持するグローバル変数なし

**結論:**
- 外部データソースの使用は**最小限**
- 環境変数（APIキーのみ）とShodan API（レスポンスデータ）のみ
- ユーザーデータの混入リスクは**非常に低い**


---

## セキュリティ分析

### 1. インジェクション攻撃のリスク評価

#### SQLインジェクション
**リスク: なし**
- データベースを使用していない
- SQLクエリを構築していない

#### コマンドインジェクション
**リスク: なし**
- シェルコマンドを実行していない
- `os.system()`, `subprocess`などを使用していない

#### URLインジェクション
**リスク: 低**

**脆弱な箇所:**
```python
# URLパスに直接埋め込み
url = f"{SHODAN_API_BASE}/shodan/host/{ip}"
url = f"{SHODAN_STREAM_BASE}/shodan/port/{port}?key={key}"
url = f"{SHODAN_API_BASE}/shodan/data/{dataset}"
```

**攻撃シナリオ:**
```python
# 悪意のある入力例
ip = "8.8.8.8/../../../admin"
dataset = "../../../etc/passwd"
```

**緩和要因:**
1. httpxライブラリが適切にURLエンコードを実行
2. Shodan APIが不正なリクエストを拒否
3. HTTPSを使用しているため、中間者攻撃のリスクが低い

**推奨対策:**
- 入力値の検証（英数字、ドット、ハイフンのみ許可）
- パストラバーサル文字列（`../`, `..\\`）の検出と拒否

#### Server-Side Request Forgery (SSRF)
**リスク: 低**

**分析:**
- URLは固定のShodan APIエンドポイントのみ
- ユーザーが任意のURLを指定できない
- ベースURLは定数として定義されている

```python
# 固定のベースURL
SHODAN_API_BASE = "https://api.shodan.io"
SHODAN_STREAM_BASE = "https://stream.shodan.io"
SHODAN_TRENDS_BASE = "https://trends.shodan.io"
```

**結論:**
- SSRFのリスクは**ほぼゼロ**
- ユーザーは内部ネットワークやローカルホストにアクセスできない

### 2. 認証情報の取り扱い

#### APIキーの管理

**取得方法:**
```python
def get_api_key(api_key: Optional[str] = None, api_type: Optional[str] = None) -> str:
    if api_key:
        return api_key  # (1) 引数から
    if api_type == "stream":
        key = os.getenv("SHODAN_STREAM_API_KEY")  # (2) 環境変数から
        if key:
            return key
    if api_type == "trends":
        key = os.getenv("SHODAN_TRENDS_API_KEY")  # (3) 環境変数から
        if key:
            return key
    key = os.getenv("SHODAN_API_KEY")  # (4) デフォルト環境変数から
    if not key:
        raise ValueError("Shodan API key must be provided...")
    return key
```

**セキュリティ評価:**

✅ **良い点:**
1. APIキーをコードにハードコードしていない
2. 環境変数を使用して秘密情報を分離
3. 優先順位ロジックが明確

⚠️ **懸念点:**
1. APIキーがログに記録される可能性
2. エラーメッセージにAPIキーが含まれる可能性
3. HTTPリクエストのクエリパラメータとしてAPIキーを送信（URLに含まれる）

**APIキーの送信方法:**
```python
# クエリパラメータとして送信
params = {"key": key, ...}
resp = await client.get(url, params=params)

# URLに直接埋め込み（Streaming API）
url = f"{SHODAN_STREAM_BASE}/shodan/banners?key={key}"
```

**リスク:**
- クエリパラメータはサーバーログに記録される可能性
- HTTPSを使用しているため、通信中の盗聴リスクは低い
- ただし、Shodan APIの仕様に従っているため、変更は困難

**推奨対策:**
1. APIキーをログに記録しない
2. エラーメッセージにAPIキーを含めない
3. 可能であれば、HTTPヘッダーでAPIキーを送信（Shodan APIの仕様次第）

### 3. データ漏洩のリスク

#### 入力データの漏洩

**リスク箇所:**
```python
# エラーメッセージに入力データが含まれる可能性
resp.raise_for_status()  # HTTPエラー時、URLが例外メッセージに含まれる
```

**シナリオ:**
1. ユーザーが機密情報を検索クエリに含める
2. Shodan APIがエラーを返す
3. エラーメッセージにクエリが含まれる
4. エラーメッセージがログに記録される

**推奨対策:**
- エラーハンドリングを改善し、機密情報をマスク
- ログ記録時に入力データをサニタイズ

#### レスポンスデータの漏洩

**現在の実装:**
```python
# レスポンスをそのまま返却
return resp.json()
return resp.text
return await _parse_sse_events(resp.aiter_bytes(), limit_val)
```

**分析:**
- Shodan APIからのレスポンスは**そのまま返却**される
- サーバー側でのフィルタリングなし
- MCPクライアントがすべてのデータを受信

**リスク:**
- Shodan APIが機密情報を返す場合、それがMCPクライアントに渡される
- ただし、Shodanは公開情報のみを提供するため、リスクは低い

**推奨対策:**
- 必要に応じて、レスポンスデータをフィルタリング
- 機密情報（APIキー、内部IPアドレスなど）を除外

### 4. サービス拒否（DoS）攻撃

#### リソース消費攻撃

**脆弱な箇所:**

1. **Streaming APIのlimit値**
```python
async def shodan_stream_firehose(api_key: Optional[str] = None, 
                                 limit: Optional[int] = 10) -> list:
    # limitに上限なし
    limit_val = limit if limit is not None else 10
```

**攻撃シナリオ:**
- 攻撃者が`limit=1000000`を指定
- サーバーが大量のイベントをメモリに保持
- メモリ不足でサーバーがクラッシュ

**推奨対策:**
```python
# limit値に上限を設定
MAX_LIMIT = 1000
limit_val = min(limit if limit is not None else 10, MAX_LIMIT)
```

2. **ページネーションの無制限リクエスト**
```python
async def shodan_host_search(query: str, ..., page: Optional[int] = 1, ...):
    # pageに上限なし
    params = {"key": key, "query": query, "page": page}
```

**攻撃シナリオ:**
- 攻撃者が`page=999999`を指定
- Shodan APIが大量のリクエストを処理
- APIクレジットが消費される

**推奨対策:**
```python
# page値に上限を設定
MAX_PAGE = 100
if page > MAX_PAGE:
    raise ValueError(f"Page number must be <= {MAX_PAGE}")
```

3. **days値の過大指定**
```python
async def shodan_trends_top_ports(query: str, days: int = 30, ...):
    # daysに上限なし
    params = {"key": key, "query": query, "days": days}
```

**攻撃シナリオ:**
- 攻撃者が`days=36500`（100年）を指定
- Shodan APIが大量のデータを処理
- レスポンスが遅延またはタイムアウト

**推奨対策:**
```python
# days値に上限を設定
MAX_DAYS = 365
if days > MAX_DAYS:
    raise ValueError(f"Days must be <= {MAX_DAYS}")
```

### 5. タイムアウトとリソース管理

#### 現在の実装

**REST API:**
```python
async with httpx.AsyncClient() as client:
    # デフォルトタイムアウト（5秒）
    resp = await client.get(url, params=params)
```

**Streaming API:**
```python
async with httpx.AsyncClient(timeout=None) as client:
    # タイムアウトなし
    async with client.stream("GET", url) as resp:
```

**分析:**

✅ **良い点:**
1. REST APIはデフォルトタイムアウトを使用
2. コンテキストマネージャーで自動クリーンアップ

⚠️ **懸念点:**
1. Streaming APIはタイムアウトなし（`timeout=None`）
2. 長時間接続が維持される可能性
3. リソースリークのリスク

**推奨対策:**
```python
# Streaming APIにもタイムアウトを設定
STREAM_TIMEOUT = 300  # 5分
async with httpx.AsyncClient(timeout=STREAM_TIMEOUT) as client:
    async with client.stream("GET", url) as resp:
```


---

## データ漏洩リスク評価

### リスクマトリックス

| データ種別 | 出所 | 使用箇所 | 漏洩リスク | 影響度 | 総合評価 |
|-----------|------|---------|-----------|--------|---------|
| APIキー | 環境変数/引数 | HTTPリクエスト | 中 | 高 | **高** |
| 検索クエリ | MCPクライアント | HTTPリクエスト | 低 | 中 | 中 |
| IPアドレス | MCPクライアント | HTTPリクエスト | 低 | 低 | 低 |
| ドメイン名 | MCPクライアント | HTTPリクエスト | 低 | 低 | 低 |
| Shodanレスポンス | Shodan API | MCPクライアント | 低 | 中 | 中 |

### 詳細分析

#### 1. APIキーの漏洩リスク

**リスクレベル: 高**

**漏洩経路:**

1. **HTTPリクエストログ**
```python
# クエリパラメータにAPIキーが含まれる
url = f"{SHODAN_API_BASE}/shodan/host/{ip}"
params = {"key": key, ...}  # ← APIキーがログに記録される可能性
```

2. **エラーメッセージ**
```python
# HTTPエラー時、URLが例外メッセージに含まれる
resp.raise_for_status()  # ← URLにAPIキーが含まれる場合、漏洩
```

3. **デバッグ出力**
```python
# 開発時にprint()やlogging()でパラメータを出力
# APIキーが含まれる可能性
```

**影響:**
- APIキーが漏洩すると、攻撃者がShodan APIを不正使用
- APIクレジットの消費
- アカウントの停止リスク

**対策:**
1. ログ記録時にAPIキーをマスク
2. エラーメッセージからAPIキーを除外
3. デバッグ出力を本番環境で無効化

#### 2. 検索クエリの漏洩リスク

**リスクレベル: 中**

**シナリオ:**
- ユーザーが機密情報を検索クエリに含める
- 例: 内部IPアドレス、社内システム名、脆弱性情報

**漏洩経路:**
1. HTTPリクエストログ（Shodan API側）
2. エラーメッセージ
3. MCPサーバーのログ

**影響:**
- 検索意図の露出
- 内部情報の漏洩
- セキュリティ調査の妨害

**対策:**
1. ユーザーに機密情報を含めないよう警告
2. ログ記録時にクエリをサニタイズ
3. 必要に応じて、クエリの一部をマスク

#### 3. Shodanレスポンスの漏洩リスク

**リスクレベル: 中**

**分析:**
- Shodanレスポンスは公開情報
- ただし、集約されると機密情報になる可能性

**シナリオ:**
- 自社ネットワークの検索結果が第三者に渡る
- 脆弱性情報が露出

**漏洩経路:**
1. MCPクライアント（Claude Desktopなど）
2. MCPクライアントのログ
3. ネットワーク通信（MCP over HTTP）

**影響:**
- セキュリティ情報の露出
- 攻撃対象の特定

**対策:**
1. MCPクライアントのセキュリティ設定を確認
2. 必要に応じて、レスポンスデータをフィルタリング
3. 機密情報を含むクエリの実行を制限

### データフロー図（セキュリティ観点）

```
┌─────────────────────────────────────────────────────────────┐
│ MCPクライアント                                              │
│  - ユーザー入力（検索クエリ、IPアドレスなど）                │
│  - 機密情報が含まれる可能性                                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓ (1) MCP Protocol (暗号化されていない可能性)
┌─────────────────────────────────────────────────────────────┐
│ Shodan MCP Server                                           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 入力データ                                            │   │
│  │  - 検証なし                                          │   │
│  │  - サニタイズなし                                    │   │
│  │  - そのままHTTPリクエストに使用                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ APIキー取得                                           │   │
│  │  - 環境変数から取得（機密情報）                       │   │
│  │  - ログに記録される可能性                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ HTTPリクエスト構築                                    │   │
│  │  - APIキーがクエリパラメータに含まれる                │   │
│  │  - ログに記録される可能性                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ↓ (2) HTTPS (暗号化)
┌─────────────────────────────────────────────────────────────┐
│ Shodan API                                                  │
│  - リクエストログに機密情報が記録される                      │
│  - APIキー、検索クエリ、IPアドレスなど                       │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓ (3) HTTPS (暗号化)
┌─────────────────────────────────────────────────────────────┐
│ Shodan MCP Server                                           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ レスポンス処理                                        │   │
│  │  - フィルタリングなし                                 │   │
│  │  - そのまま返却                                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                     ↓                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ↓ (4) MCP Protocol (暗号化されていない可能性)
┌─────────────────────────────────────────────────────────────┐
│ MCPクライアント                                              │
│  - Shodanレスポンスを受信                                    │
│  - ログに記録される可能性                                    │
└─────────────────────────────────────────────────────────────┘
```

**セキュリティギャップ:**
1. MCP Protocolの暗号化状態が不明
2. 入力データの検証なし
3. APIキーがログに記録される可能性
4. レスポンスデータのフィルタリングなし

---

## 推奨事項

### 優先度: 高

#### 1. 入力検証の実装

**目的:** インジェクション攻撃とDoS攻撃を防止

**実装例:**
```python
import re
from typing import Optional

def validate_ip(ip: str) -> str:
    """IPアドレスの検証"""
    # IPv4形式のチェック
    ipv4_pattern = r'^(\d{1,3}\.){3}\d{1,3}$'
    if not re.match(ipv4_pattern, ip):
        raise ValueError(f"Invalid IP address: {ip}")
    # 各オクテットが0-255の範囲内かチェック
    octets = ip.split('.')
    if not all(0 <= int(octet) <= 255 for octet in octets):
        raise ValueError(f"Invalid IP address: {ip}")
    return ip

def validate_port(port: int) -> int:
    """ポート番号の検証"""
    if not 1 <= port <= 65535:
        raise ValueError(f"Port must be between 1 and 65535, got {port}")
    return port

def validate_dataset(dataset: str) -> str:
    """データセット名の検証（パストラバーサル防止）"""
    if '..' in dataset or '/' in dataset or '\\' in dataset:
        raise ValueError(f"Invalid dataset name: {dataset}")
    if not re.match(r'^[a-zA-Z0-9\-_]+$', dataset):
        raise ValueError(f"Dataset name must contain only alphanumeric characters, hyphens, and underscores")
    return dataset

def validate_limit(limit: Optional[int], max_limit: int = 1000) -> int:
    """limit値の検証"""
    if limit is None:
        return 10  # デフォルト値
    if limit < 1:
        raise ValueError(f"Limit must be positive, got {limit}")
    if limit > max_limit:
        raise ValueError(f"Limit must be <= {max_limit}, got {limit}")
    return limit

# 使用例
async def shodan_host_info(ip: str, api_key: Optional[str] = None, 
                          history: Optional[bool] = False, 
                          minify: Optional[bool] = False) -> dict:
    ip = validate_ip(ip)  # ← 検証を追加
    key = get_api_key(api_key, api_type="rest")
    # ...
```

#### 2. APIキーのマスキング

**目的:** ログやエラーメッセージからAPIキーを保護

**実装例:**
```python
def mask_api_key(key: str) -> str:
    """APIキーをマスク（最初の4文字と最後の4文字のみ表示）"""
    if len(key) <= 8:
        return "****"
    return f"{key[:4]}...{key[-4:]}"

def get_api_key(api_key: Optional[str] = None, api_type: Optional[str] = None) -> str:
    # ... (既存のロジック)
    if not key:
        # エラーメッセージにAPIキーを含めない
        raise ValueError("Shodan API key must be provided as argument or in SHODAN_API_KEY env var.")
    # ログ記録時はマスク
    # logger.info(f"Using API key: {mask_api_key(key)}")
    return key
```

#### 3. エラーハンドリングの改善

**目的:** エラーメッセージから機密情報を除外

**実装例:**
```python
async def shodan_host_info(ip: str, api_key: Optional[str] = None, 
                          history: Optional[bool] = False, 
                          minify: Optional[bool] = False) -> dict:
    key = get_api_key(api_key, api_type="rest")
    params = {"key": key}
    if history:
        params["history"] = "true"
    if minify:
        params["minify"] = "true"
    url = f"{SHODAN_API_BASE}/shodan/host/{ip}"
    
    try:
        async with httpx.AsyncClient() as client:
            resp = await client.get(url, params=params)
            resp.raise_for_status()
            return resp.json()
    except httpx.HTTPStatusError as e:
        # エラーメッセージからAPIキーを除外
        error_msg = f"Shodan API error: {e.response.status_code}"
        # URLやパラメータを含めない
        raise ValueError(error_msg) from e
    except httpx.RequestError as e:
        # ネットワークエラー
        raise ValueError(f"Network error: {type(e).__name__}") from e
```

### 優先度: 中

#### 4. レート制限の実装

**目的:** DoS攻撃とAPIクレジットの過剰消費を防止

**実装例:**
```python
from collections import defaultdict
from time import time

class RateLimiter:
    def __init__(self, max_requests: int = 10, window: int = 60):
        self.max_requests = max_requests
        self.window = window
        self.requests = defaultdict(list)
    
    def check(self, client_id: str) -> bool:
        now = time()
        # 古いリクエストを削除
        self.requests[client_id] = [
            req_time for req_time in self.requests[client_id]
            if now - req_time < self.window
        ]
        # レート制限チェック
        if len(self.requests[client_id]) >= self.max_requests:
            return False
        self.requests[client_id].append(now)
        return True

# グローバルインスタンス
rate_limiter = RateLimiter(max_requests=10, window=60)

# 使用例
async def shodan_host_info(ip: str, api_key: Optional[str] = None, ...):
    # クライアントIDを取得（MCPから提供される場合）
    client_id = "default"  # 実際にはMCPクライアントのIDを使用
    if not rate_limiter.check(client_id):
        raise ValueError("Rate limit exceeded. Please try again later.")
    # ...
```

#### 5. タイムアウトの設定

**目的:** リソースリークとDoS攻撃を防止

**実装例:**
```python
# Streaming APIにタイムアウトを設定
STREAM_TIMEOUT = 300  # 5分

async def shodan_stream_firehose(api_key: Optional[str] = None, 
                                 limit: Optional[int] = 10) -> list:
    key = get_api_key(api_key, api_type="stream")
    url = f"{SHODAN_STREAM_BASE}/shodan/banners?key={key}"
    limit_val = validate_limit(limit, max_limit=1000)
    
    # タイムアウトを設定
    async with httpx.AsyncClient(timeout=STREAM_TIMEOUT) as client:
        async with client.stream("GET", url) as resp:
            resp.raise_for_status()
            return await _parse_sse_events(resp.aiter_bytes(), limit_val)
```

### 優先度: 低

#### 6. レスポンスデータのフィルタリング

**目的:** 機密情報の漏洩を防止

**実装例:**
```python
def filter_response(data: dict) -> dict:
    """レスポンスデータから機密情報を除外"""
    # 必要に応じて実装
    # 例: 内部IPアドレス、APIキーなどを除外
    return data

async def shodan_host_info(ip: str, ...) -> dict:
    # ...
    result = resp.json()
    return filter_response(result)  # ← フィルタリングを追加
```

---

## まとめ

### 現在の実装の評価

#### 良い点

1. **外部データソースの最小化**
   - 環境変数（APIキーのみ）とShodan API（レスポンス）のみ使用
   - ファイルシステム、データベース、システムコマンドは使用していない

2. **データフローの透明性**
   - 入力データがどのように使用されるか明確
   - レスポンスデータがそのまま返却される

3. **HTTPSの使用**
   - すべての通信が暗号化されている
   - 中間者攻撃のリスクが低い

4. **リソース管理**
   - コンテキストマネージャーで自動クリーンアップ
   - リソースリークのリスクが低い

#### 改善が必要な点

1. **入力検証の欠如**
   - すべての入力パラメータが検証されていない
   - インジェクション攻撃のリスク

2. **APIキーの保護不足**
   - ログやエラーメッセージに含まれる可能性
   - マスキング機能なし

3. **DoS攻撃への脆弱性**
   - limit、page、daysなどのパラメータに上限なし
   - レート制限なし

4. **エラーハンドリングの不足**
   - エラーメッセージに機密情報が含まれる可能性
   - 詳細なエラー情報が露出

### 総合評価

**セキュリティレベル: 中**

- 基本的なセキュリティ対策（HTTPS、環境変数）は実装されている
- ただし、入力検証、APIキー保護、DoS対策が不足
- 本番環境での使用前に、推奨事項の実装を強く推奨

### 次のステップ

1. **優先度: 高**の推奨事項を実装
2. セキュリティテストを実施（ペネトレーションテスト、脆弱性スキャン）
3. ログ記録とモニタリングの実装
4. セキュリティレビューの実施
5. ドキュメントの更新（セキュリティガイドライン）

このドキュメントが、Shodan MCP Serverのセキュリティ向上に役立つことを願っています。
